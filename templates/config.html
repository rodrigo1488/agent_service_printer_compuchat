{% extends "base.html" %}
{% block title %}Configuração - Print Agent{% endblock %}
{% block content %}
<h1>Configuração do Print Agent</h1>
{% if message %}
<div class="alert {{ 'alert-success' if message_type == 'success' else 'alert-error' }}">{{ message }}</div>
{% endif %}
<form method="post" action="/config" id="config-form">
    <fieldset style="margin-bottom: 1.5rem;">
        <legend style="margin-bottom: 0.5rem; font-weight: 600;">Conexão SaaS</legend>
        <div class="form-group">
            <label for="ws_url">URL WebSocket</label>
            <input type="url" id="ws_url" name="ws_url" value="{{ ws_url }}" placeholder="wss://api.dominio.com/ws/print">
        </div>
    </fieldset>

    <fieldset>
        <legend style="margin-bottom: 0.5rem; font-weight: 600;">Impressoras</legend>
        <p style="color:#666; font-size: 0.9rem;">Cada impressora corresponde a um dispositivo (Device ID + Token) no SaaS e a uma impressora física (IP/porta). As impressoras são cadastradas no sistema (banco de dados); aqui você associa cada uma ao IP da impressora local.</p>
        <div id="printers-container">
            {% for p in printers %}
            <div class="printer-block" data-index="{{ loop.index0 }}">
                <hr style="margin: 1rem 0;">
                <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">Impressora {{ loop.index }}</h3>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <div class="form-group">
                        <label>Device ID</label>
                        <input type="text" name="printer_{{ loop.index0 }}_device_id" value="{{ p.device_id }}" placeholder="ex: cozinha-01">
                    </div>
                    <div class="form-group">
                        <label>Token (Bearer)</label>
                        <input type="password" name="printer_{{ loop.index0 }}_token" value="{{ p.token }}" placeholder="Token do dispositivo">
                    </div>
                </div>
                <div class="form-group">
                    <label>Nome (opcional)</label>
                    <input type="text" name="printer_{{ loop.index0 }}_name" value="{{ p.name }}" placeholder="ex: Cozinha">
                </div>
                <div class="form-group">
                    <label>Tipo de Conexão</label>
                    <select name="printer_{{ loop.index0 }}_connection_type" class="connection-type-select" data-index="{{ loop.index0 }}">
                        <option value="network" {% if p.get('connection_type', 'network') == 'network' %}selected{% endif %}>Rede (IP/Porta)</option>
                        <option value="local" {% if p.get('connection_type') == 'local' %}selected{% endif %}>Local (Windows)</option>
                    </select>
                </div>
                <div class="network-config" id="network-config-{{ loop.index0 }}" style="{% if p.get('connection_type') == 'local' %}display: none;{% endif %}">
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div class="form-group">
                            <label>IP da impressora</label>
                            <input type="text" name="printer_{{ loop.index0 }}_printer_ip" value="{{ p.printer_ip }}">
                        </div>
                        <div class="form-group">
                            <label>Porta</label>
                            <input type="number" name="printer_{{ loop.index0 }}_printer_port" value="{{ p.printer_port }}">
                        </div>
                    </div>
                </div>
                <div class="local-config" id="local-config-{{ loop.index0 }}" style="{% if p.get('connection_type') != 'local' %}display: none;{% endif %}">
                    <div class="form-group">
                        <label>Impressora Local</label>
                        <select name="printer_{{ loop.index0 }}_printer_name_local" id="printer-name-local-{{ loop.index0 }}" data-saved-value="{{ p.get('printer_name_local', '') }}">
                            <option value="">Carregando impressoras...</option>
                        </select>
                        <button type="button" class="btn-refresh-printers" data-index="{{ loop.index0 }}" style="margin-top: 0.5rem;">Atualizar lista</button>
                    </div>
                </div>
                <div class="network-only-config" id="network-only-config-{{ loop.index0 }}" style="{% if p.get('connection_type') == 'local' %}display: none;{% endif %}">
                    <div class="form-group">
                        <label>Tipo</label>
                        <select name="printer_{{ loop.index0 }}_printer_type">
                            <option value="raw" {% if p.printer_type == 'raw' %}selected{% endif %}>RAW (porta 9100)</option>
                            <option value="ipp" {% if p.printer_type == 'ipp' %}selected{% endif %}>IPP</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Largura do papel (caracteres)</label>
                    <input type="number" name="printer_{{ loop.index0 }}_paper_width" value="{{ p.paper_width }}" min="24" max="48">
                </div>
        <div class="form-group">
            <label>Codificação</label>
            <select name="printer_{{ loop.index0 }}_printer_encoding">
                <option value="cp850" {% if p.printer_encoding == 'cp850' %}selected{% endif %}>CP850</option>
                <option value="cp860" {% if p.printer_encoding == 'cp860' %}selected{% endif %}>CP860</option>
                <option value="cp1252" {% if p.printer_encoding == 'cp1252' %}selected{% endif %}>CP1252</option>
                <option value="utf8" {% if p.printer_encoding == 'utf8' %}selected{% endif %}>UTF-8</option>
            </select>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <button type="button" class="btn-test-printer" data-index="{{ loop.index0 }}" style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Testar Impressora</button>
            <button type="button" class="btn-remove" aria-label="Remover impressora">Remover</button>
        </div>
            </div>
            {% endfor %}
        </div>
        <div style="margin-top: 1rem;">
            <button type="button" id="add-printer">Adicionar impressora</button>
        </div>
    </fieldset>
    <div style="margin-top: 1.5rem;">
        <button type="submit">Salvar configuração</button>
    </div>
</form>

<template id="printer-block-tpl">
    <div class="printer-block" data-index="">
        <hr style="margin: 1rem 0;">
        <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">Impressora <span class="printer-num"></span></h3>
        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
            <div class="form-group">
                <label>Device ID</label>
                <input type="text" name="printer_X_device_id" placeholder="ex: cozinha-01">
            </div>
            <div class="form-group">
                <label>Token (Bearer)</label>
                <input type="password" name="printer_X_token" placeholder="Token do dispositivo">
            </div>
        </div>
        <div class="form-group">
            <label>Nome (opcional)</label>
            <input type="text" name="printer_X_name" placeholder="ex: Cozinha">
        </div>
        <div class="form-group">
            <label>Tipo de Conexão</label>
            <select name="printer_X_connection_type" class="connection-type-select" data-index="X">
                <option value="network" selected>Rede (IP/Porta)</option>
                <option value="local">Local (Windows)</option>
            </select>
        </div>
        <div class="network-config" id="network-config-X">
            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                <div class="form-group">
                    <label>IP da impressora</label>
                    <input type="text" name="printer_X_printer_ip" value="192.168.1.100">
                </div>
                <div class="form-group">
                    <label>Porta</label>
                    <input type="number" name="printer_X_printer_port" value="9100">
                </div>
            </div>
        </div>
        <div class="local-config" id="local-config-X" style="display: none;">
            <div class="form-group">
                <label>Impressora Local</label>
                <select name="printer_X_printer_name_local" id="printer-name-local-X">
                    <option value="">Carregando impressoras...</option>
                </select>
                <button type="button" class="btn-refresh-printers" data-index="X" style="margin-top: 0.5rem;">Atualizar lista</button>
            </div>
        </div>
        <div class="network-only-config" id="network-only-config-X">
            <div class="form-group">
                <label>Tipo</label>
                <select name="printer_X_printer_type">
                    <option value="raw" selected>RAW (porta 9100)</option>
                    <option value="ipp">IPP</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>Largura do papel (caracteres)</label>
            <input type="number" name="printer_X_paper_width" value="32" min="24" max="48">
        </div>
        <div class="form-group">
            <label>Codificação</label>
            <select name="printer_X_printer_encoding">
                <option value="cp850" selected>CP850</option>
                <option value="cp860">CP860</option>
                <option value="cp1252">CP1252</option>
                <option value="utf8">UTF-8</option>
            </select>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <button type="button" class="btn-test-printer" data-index="X" style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Testar Impressora</button>
            <button type="button" class="btn-remove" aria-label="Remover impressora">Remover</button>
        </div>
    </div>
</template>

<script>
(function() {
    var container = document.getElementById('printers-container');
    var tpl = document.getElementById('printer-block-tpl');
    var addBtn = document.getElementById('add-printer');

    function nextIndex() {
        var blocks = container.querySelectorAll('.printer-block');
        var max = -1;
        blocks.forEach(function(b) {
            var idx = parseInt(b.getAttribute('data-index'), 10);
            if (!isNaN(idx) && idx > max) max = idx;
        });
        return max + 1;
    }

    function setBlockIndex(block, idx) {
        block.setAttribute('data-index', idx);
        var numEl = block.querySelector('.printer-num');
        if (numEl) numEl.textContent = idx + 1;
        block.querySelectorAll('[name]').forEach(function(input) {
            var n = input.getAttribute('name');
            if (n && n.indexOf('printer_') === 0) {
                var rest = n.replace(/^printer_(X|\d+)_/, '');
                input.setAttribute('name', 'printer_' + idx + '_' + rest);
            }
        });
        // Atualizar IDs dos elementos dinâmicos
        block.querySelectorAll('[id]').forEach(function(el) {
            var id = el.getAttribute('id');
            if (!id) return;
            
            // Atualizar IDs específicos - substituir X ou número pelo índice atual
            if (id.indexOf('network-config-') >= 0) {
                el.setAttribute('id', 'network-config-' + idx);
            } else if (id.indexOf('local-config-') >= 0) {
                el.setAttribute('id', 'local-config-' + idx);
            } else if (id.indexOf('network-only-config-') >= 0) {
                el.setAttribute('id', 'network-only-config-' + idx);
            } else if (id.indexOf('printer-name-local-') >= 0) {
                el.setAttribute('id', 'printer-name-local-' + idx);
            } else if (id.indexOf('printer-') === 0) {
                var newId = id.replace(/printer-.*?-(X|\d+)/, 'printer-$1-' + idx);
                el.setAttribute('id', newId);
            }
        });
        // Atualizar data-index dos botões
        block.querySelectorAll('[data-index]').forEach(function(el) {
            if (el.classList.contains('connection-type-select') || el.classList.contains('btn-refresh-printers') || el.classList.contains('btn-test-printer')) {
                el.setAttribute('data-index', idx);
            }
        });
    }

    addBtn.addEventListener('click', function() {
        var idx = nextIndex();
        var clone = tpl.content.cloneNode(true);
        var block = clone.querySelector('.printer-block');
        setBlockIndex(block, idx);
        block.querySelector('.printer-num').textContent = idx + 1;
        container.appendChild(clone);
        bindRemove(block);
        bindConnectionType(block);
        bindTestPrinter(block);
    });

    function bindRemove(block) {
        block.querySelector('.btn-remove').addEventListener('click', function() {
            block.remove();
            renumberBlocks();
        });
    }

    function bindTestPrinter(block) {
        var btn = block.querySelector('.btn-test-printer');
        if (!btn) return;
        
        btn.addEventListener('click', function() {
            var index = btn.getAttribute('data-index');
            var prefix = 'printer_' + index + '_';
            
            // Coletar dados do formulário
            var connectionType = block.querySelector('[name="' + prefix + 'connection_type"]').value;
            var testData = {
                connection_type: connectionType,
                paper_width: block.querySelector('[name="' + prefix + 'paper_width"]').value || '32',
                printer_encoding: block.querySelector('[name="' + prefix + 'printer_encoding"]').value || 'cp850',
            };
            
            if (connectionType === 'local') {
                var printerNameLocal = block.querySelector('[name="' + prefix + 'printer_name_local"]').value;
                if (!printerNameLocal) {
                    alert('Selecione uma impressora local primeiro');
                    return;
                }
                testData.printer_name_local = printerNameLocal;
            } else {
                var printerIp = block.querySelector('[name="' + prefix + 'printer_ip"]').value;
                var printerPort = block.querySelector('[name="' + prefix + 'printer_port"]').value || '9100';
                var printerType = block.querySelector('[name="' + prefix + 'printer_type"]').value || 'raw';
                
                if (!printerIp) {
                    alert('Informe o IP da impressora primeiro');
                    return;
                }
                testData.printer_ip = printerIp;
                testData.printer_port = parseInt(printerPort);
                testData.printer_type = printerType;
            }
            
            // Desabilitar botão durante o teste
            btn.disabled = true;
            btn.textContent = 'Testando...';
            
            fetch('/api/test-printer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testData)
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    alert('✓ ' + data.message);
                } else {
                    alert('✗ Erro: ' + (data.error || 'Falha ao testar impressora'));
                }
            })
            .catch(function(error) {
                alert('✗ Erro ao conectar: ' + error.message);
            })
            .finally(function() {
                btn.disabled = false;
                btn.textContent = 'Testar Impressora';
            });
        });
    }

    function renumberBlocks() {
        container.querySelectorAll('.printer-block').forEach(function(block, i) {
            setBlockIndex(block, i);
        });
    }

    container.querySelectorAll('.printer-block').forEach(function(block) {
        bindRemove(block);
        bindTestPrinter(block);
    });
    
    // Função para carregar impressoras locais
    function loadLocalPrinters(selectId, index) {
        var select = document.getElementById(selectId);
        if (!select) return;
        
        var savedValue = select.getAttribute('data-saved-value') || '';
        select.innerHTML = '<option value="">Carregando...</option>';
        
        fetch('/api/local-printers')
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.error) {
                    select.innerHTML = '<option value="">' + data.error + '</option>';
                    console.error('Erro ao carregar impressoras:', data.error);
                    return;
                }
                
                select.innerHTML = '<option value="">Selecione uma impressora</option>';
                if (data.printers && data.printers.length > 0) {
                    data.printers.forEach(function(printer) {
                        var option = document.createElement('option');
                        option.value = printer.name;
                        option.textContent = printer.name;
                        if (printer.name === savedValue) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">Nenhuma impressora encontrada</option>';
                }
            })
            .catch(function(error) {
                select.innerHTML = '<option value="">Erro ao conectar: ' + error.message + '</option>';
                console.error('Erro ao carregar impressoras:', error);
            });
    }
    
    // Função para alternar entre rede e local
    function toggleConnectionType(select, index) {
        var connectionType = select.value;
        var networkConfig = document.getElementById('network-config-' + index);
        var localConfig = document.getElementById('local-config-' + index);
        var networkOnlyConfig = document.getElementById('network-only-config-' + index);
        var printerNameLocal = document.getElementById('printer-name-local-' + index);
        
        if (connectionType === 'local') {
            // Ocultar campos de rede
            if (networkConfig) networkConfig.style.display = 'none';
            if (networkOnlyConfig) networkOnlyConfig.style.display = 'none';
            // Mostrar campo de impressora local
            if (localConfig) localConfig.style.display = 'block';
            // Carregar lista de impressoras se necessário
            if (printerNameLocal && (printerNameLocal.options.length <= 1 || printerNameLocal.innerHTML.indexOf('Carregando') >= 0)) {
                loadLocalPrinters('printer-name-local-' + index, index);
            }
        } else {
            // Mostrar campos de rede
            if (networkConfig) networkConfig.style.display = 'block';
            if (networkOnlyConfig) networkOnlyConfig.style.display = 'block';
            // Ocultar campo de impressora local
            if (localConfig) localConfig.style.display = 'none';
        }
    }
    
    // Bind eventos de mudança de tipo de conexão
    function bindConnectionType(block) {
        var select = block.querySelector('.connection-type-select');
        if (select) {
            var index = block.getAttribute('data-index');
            
            // Adicionar event listener para mudança
            select.addEventListener('change', function() {
                toggleConnectionType(this, index);
            });
            
            // Aplicar estado inicial imediatamente
            toggleConnectionType(select, index);
        }
        
        // Bind botão de atualizar lista de impressoras
        var refreshBtn = block.querySelector('.btn-refresh-printers');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                var idx = this.getAttribute('data-index');
                loadLocalPrinters('printer-name-local-' + idx, idx);
            });
        }
    }
    
    // Aplicar bind em todos os blocos existentes ao carregar a página
    // Usar DOMContentLoaded ou setTimeout para garantir que o DOM está pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            container.querySelectorAll('.printer-block').forEach(function(block) {
                bindConnectionType(block);
            });
        });
    } else {
        // DOM já está pronto
        container.querySelectorAll('.printer-block').forEach(function(block) {
            bindConnectionType(block);
        });
    }
})();
</script>
{% endblock %}
